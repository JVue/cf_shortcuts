#!/bin/bash
#
# Author: Jeffrey Cutter
# License: GPL v3
#
# Note: This program can enable you to do things faster, including mistakes, use at your own risk.
#

TAIL_NUMBER=3
NAME=$(basename $0)
DIR=$(dirname $0)
cfhosts_cmd="$DIR/cfhosts.rb"
cfhosts_file="$DIR/cfhosts"

groups=$($cfhosts_cmd $cfhosts_file list_groups)

function usage {
  echo
  case $NAME in
    "cfssh") echo "USAGE: $NAME group command args" ;;
    "cfscp") echo "USAGE: $NAME group local_file remote_dest_dir" ;;
    "cfcollect") echo "USAGE: $NAME group remote_file local_dest_dir" ;;
    "cfgrep"|"cfgrep-collate")
      echo "USAGE: $NAME [-i] group pattern log_file [count]"
      echo
      echo "  For CloudForms logs, log_file can be in the format of evm or evm.log"
      echo "  For any other files to grep, use /the/full/path/to/file"
      echo "  -i is optional to ignore case with grep"
      echo "  count is optional with cfgrep only and used with tail to limit the output, default is $TAIL_NUMBER"
      ;;
    "cfgrep-request")
      echo "USAGE: $NAME [-i] group request_id [log_file]"
      echo
      echo "  Will grep and collate CloudForms logs for a request_id and all its associated tasks"
      echo "  log_file is optional and defaults to automation.log"
      ;;
  esac
  echo
  echo "	Available groups:"
  for i in $groups
  do
    echo "	$i"
  done
  echo
  echo "To see matching hosts for a given group, use:"
  echo
  echo "$NAME <group> list"
  echo
  echo "-h | --help for this usage statement."
  echo
  exit 1
}

function clean_tmp_file {
  rm -f $TMPFILE
}

trap clean_tmp_file EXIT


GREP="egrep"
if [[ "$NAME" == 'cfgrep' || "$NAME" == 'cfgrep-collate' ]]
then
  if [ "$1" == '-i' ]
  then
    GREP="$GREP -i"
    shift
  fi
fi

if [[ $1 == "-h" || $1 == "--help" || $# -eq 0 ]]
then
  usage
fi

if [[ "$NAME" == "cfssh" || "$2" == "list" ]]
then
  if [ $# -lt 2 ]
  then
    echo
    echo "Not enough arguments!"
    usage
  fi
elif [ "$NAME" == "cfgrep" ]
then
  if [[ $# -ne 3 && $# -ne 4 ]]
  then
    echo
    echo "Wrong number of arguments!"
    usage
  fi
elif [ "$NAME" == "cfgrep-request" ]
then
  if [[ $# -ne 2 && $# -ne 3 ]]
  then
    echo
    echo "Wrong number of arguments!"
    usage
  fi
  if [ ! -d '/var/www/miq/vmdb' ]
  then
    echo
    echo "$NAME will only work when run from a CloudForms appliance!"
    usage
  fi
else
  if [ $# -ne 3 ]
  then
    echo
    echo "Wrong number of arguments!"
    usage
  fi
fi

group=$1
shift

if [ ! -r "$cfhosts_file" ]
then
  echo
  echo "$cfhosts_file not available!"
  usage
fi

if [ ! -x "$cfhosts_cmd" ]
then
  echo
  echo "$cfhosts_file not executable!"
  usage
fi

# Check that we have a ruby available for cfhosts_cmd to use
/usr/bin/env ruby --version > /dev/null 2>&1
if [ $? -ne 0 ]
then
  echo
  echo "Unable to find ruby with /usr/bin/env ruby.  Please make sure ruby is installed."
  usage
fi

group_good=false

for i in $groups
do
  if [ "$i" == "$group" ]
  then
    group_good=true
  fi
done

if [ "$group_good" != "true" ]
then
  echo
  echo "Group $group not found in $cfhosts_file"
  usage
fi

echo

SERVERS=$($cfhosts_cmd $cfhosts_file list_servers $group)

if [ "$1" == "list" ]
then
  echo "Matching servers:"
  for i in $SERVERS
  do
    echo $i
  done
  exit
fi

if [[ "$NAME" == 'cfgrep' || "$NAME" == 'cfgrep-collate' || "$NAME" == 'cfgrep-request' ]]
then
  PATTERN="$1"
  if [ "$NAME" == 'cfgrep-request' ]
  then
    REQUEST_ID=$(echo $PATTERN | sed 's/,//g')
    echo "*** looking for tasks associated with request_id: $REQUEST_ID ***"
    cd /var/www/miq/vmdb
    TASK_IDS=$(echo "select id from miq_request_tasks where miq_request_id = $REQUEST_ID" | rails db | awk '$1!="id" && !/^---/ && !/^\(/ {print $1}' | sort -n)
    echo
    TASK_IDS=$(echo $TASK_IDS)
    cd - > /dev/null
    PATTERN="$REQUEST_ID|$(echo $TASK_IDS | sed 's/ /|/g')"
    echo "*** looking for request_id: $REQUEST_ID and task_ids: $TASK_IDS ***"
    echo
  fi
  PATTERN=$(echo $PATTERN | sed -e 's/|/\\|/g')
  LOG=$2
  if [[ "$NAME" == 'cfgrep-request' && -z "$LOG" ]]
  then
    LOG='automation.log'
  fi
  if [ "$(echo $LOG | cut -c1)" != "/" ]
  then
    LOG="/var/www/miq/vmdb/log/$(echo $LOG | sed 's/\.log$//').log"
  fi
  if [ -n "$3" ]
  then
    TAIL_NUMBER=$3
  fi
  if [[ "$NAME" == 'cfgrep' ]]
  then
    TAIL="tail -$TAIL_NUMBER"
  else
    TAIL="tail"
  fi
fi

ARGS=$*
ARGS=$(echo $ARGS | sed 's/*/\\*/g')

TMPFILE="/tmp/.$NAME.$$"
if [ -e "$TMPFILE" ]
then
  echo "TMPFILE $TMPFILE already exists!"
  exit 1
fi

for i in $SERVERS
do
  echo "*** $i ***"
  case $NAME in
    "cfssh") ssh root@$i $ARGS ;;
    "cfscp") scp $1 root@$i:$2 ;;
    "cfcollect") scp root@$i:$1 $2/$(basename $1)-$i ;;
    "cfgrep") ssh root@$i $GREP "$PATTERN" $LOG \| $TAIL ;;
    "cfgrep-collate"|"cfgrep-request") ssh root@$i $GREP "$PATTERN" $LOG | sed -e "s/^/[$i] /" >> $TMPFILE ;;
  esac
  echo
done

if [[ "$NAME" == 'cfgrep-collate' || "$NAME" == 'cfgrep-request' ]]
then
  echo "*** collating results ***"
  sort -k 3 $TMPFILE | less
  echo
fi
